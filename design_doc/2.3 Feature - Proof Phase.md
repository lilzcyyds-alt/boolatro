# 2.3 Feature - Proof Phase

## 目标

实现游戏的核心玩法：**Proof Phase (证明阶段)**。玩家需要构造一个结论，并编写完整的逻辑证明过程来获取分数，以达成盲注的目标。

## 流程图

```mermaid
graph TD
    Start[开始 Proof 阶段] --> GenTask[生成 Premise & Conclusion]
    GenTask --> BuildStage[构造结论模式]
    BuildStage -->|点击卡片| AddToken[添加符号到结论]
    BuildStage -->|Edit Proof| DeductHand[扣除一次手牌]
    DeductHand --> ProofEditor[进入引导式证明编辑器]
    
    subgraph Editor [编辑器逻辑]
        ProofEditor --> StartFlow[点击 ADD LINE]
        StartFlow --> SelectRule[选择逻辑规则]
        SelectRule --> HighlightSources[系统高亮可选来源/片段]
        HighlightSources --> PickSource[点击高亮片段]
        PickSource --> AutoFill[自动填充公式/引用]
        AutoFill --> Submit[点击 Submit 提交]
        Submit --> Validate[逻辑验证]
        Validate --> Score[计算并累加分数]
        Score --> GoalCheck{分数达标?}
    end
```

## 核心机制 (Mechanics)

### 1. 任务生成 (Task Generation)
- 使用 `ProofTaskGenerator` 根据当前难度和电路等级生成 `Premise`。
- `Conclusion` 由玩家自行构造（目前版本），或由系统预设。

### 2. 逻辑验证系统 (Validation)
由 `ProofValidator` 负责：
- **WFF 检查**: 确保所有输入的公式符合逻辑语法。
- **规则验证**: 支持以下逻辑规则：
  - `reit`: 重复。
  - `&elim`: 合取消除。
  - `&intro`: 合取引入 (Introduction)。
  - `~elim`: 双重否定消除 (Elimination)。
  - `~intro`: 双重否定引入 (Introduction)。
- **自动完成 (Auto-finalization)**: 当编辑器中生成的推导结果与目标结论（Conclusion）逻辑等价时，系统会自动填充最后一行引用并立即提交证明。
- **完整性验证**: 验证最后一行证明是否与目标结论完全一致。

#### 自动完成流程 (Auto-Finalization Flow)

```mermaid
graph TD
    SelectRule[选择规则] --> SelectSource[点击来源片段]
    SelectSource --> Calculate[计算推导结果]
    Calculate --> Compare{结果匹配目标结论?}
    Compare -->|是| AutoFill[自动填充规则与引用]
    AutoFill --> AutoSubmit[自动触发提交]
    Compare -->|否| AddLine[添加为新推理行]
    AddLine --> Continue[继续推理]
```

当玩家通过引导式流程选择规则和来源时，系统会自动计算推导结果。如果该结果（经过括号标准化后）与目标结论完全匹配，系统会自动将规则和引用填入结论行，并立即触发提交验证。

### 3. 计分系统 (Scoring)
- **有效证明**: 基于证明行数、公式复杂度和特殊卡牌效果计算。
- **无效证明**: 给予少量“安慰分”（Fallback Score）。

### 4. 资源管理 (Resources)
- **手牌 (Hands)**:
  - 进入编辑器即消耗一次 `handsRemaining`。
  - 同一编辑器会话中的所有提交（包括修改后重试）不再额外消耗手牌。
  - 手牌归零且未达标时，阶段流转至 `Defeat`。
- **符号手牌 (Symbol Hand)**: 底部用于构造结论的符号卡片，在退出编辑器时会自动补充。

## UI 实现
- **StageComponent**: 负责在"构造模式"和"编辑模式"之间切换。
- **ProofEditor (Guided Flow)**:
  - **简洁界面**: 编辑器内不显示分数、目标和手牌，专注于证明逻辑。
  - **无需键盘**: 全部交互通过点击完成。
  - **引导式输入**: 采用"先选规则，后点来源"的流程。
  - **交互式公式 (FormulaView)**: 前序行中的公式段落（如合取项）在特定条件下会变为可点击状态，点击即可自动填入当前行。
  - **验证反馈弹窗**: 提交后，验证结果（VALID/INVALID、消息、分数增量）以居中弹窗形式显示。
  - **流畅动画**:
    - 编辑器打开时从卡片位置飞入（500ms，easeOutCubic）。
    - 提交后显示验证弹窗2秒，然后编辑器与弹窗一起飞出屏幕（500ms，easeInCubic）。
  - **状态清理**: 每次打开编辑器时，自动清空上次的中间推理行，仅保留前提和结论。
- **ScoringPanel**: 在游戏世界中实时反馈当前分数、目标分数及剩余手牌（独立于编辑器）。

## 状态管理
- `ProofState`: 维护当前证明任务、已构造结论、编辑器草稿及验证反馈。
- `RunState`: 协调阶段流转，并作为 `EffectEngine` 的入口应用各种特殊卡牌加成。
