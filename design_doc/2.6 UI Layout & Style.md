# 2.6 UI Layout & Style

## 设计目标

构建一个高度还原 Balatro 风格、以 **16:9** 为基准比例、且深度集成 **Flame Engine** 的游戏化界面。

## 布局架构 (Layout Architecture)

整体布局遵循 **"一切皆为 GameObject"** 的原则，并采用严格的层级管理。

### 1. 分辨率标准与静态锚点
- **基准分辨率**: 锁定为 **1920x1080 px**。
- **静态锚点原则**: `RootLayoutComponent` (Layer 0) 是最外层的静态容器，它在整个游戏生命周期中保持位置 (0, 0) 不变。所有的全局缩放都基于此 1080p 基准。

### 2. 层级架构 (Hierarchy Layers)

| 层级 | 名称 | 职责描述 |
| :--- | :--- | :--- |
| **Layer 0** | **Root Layout** | 静态基准容器，负责全局坐标系对齐。 |
| **Layer 1** | **区域容器 (Section Containers)** | UI 的核心物理分区（如 Joker 栏、计分板、舞台等）。负责自身在 1080p 空间内的飞入/飞出定位。 |
| **Layer 2+** | **GameObject** | 具体的 UI 元素（按钮、卡牌、文字等）。负责区域内部的局部布局和交互逻辑。 |

### 3. 核心区域划分 (Layer 1)

整体画面基于 1920x1080 坐标系进行严格的网格切分。为了保证视觉上的呼吸感，每个区域之间以及与屏幕边缘之间均保留约 **10 px** 的间隙（Gap/Margin）。

```text
+-----------------------------------------------------------------------+
|  [10px Margin]                                                        |
|  +----------+  +---------------------------------------+  +---------+ |
|  | Phase    |  | Region A: Joker Row (Top)             |  | (Action | |
|  | Info     |  | Position: (250, 10)                   |  |  Ext)   | |
|  | (10,10)  |  | Size: (1420, 120)                     |  |         | |
|  +----------+  +---------------------------------------+  +---------+ |
|                                                                       |
|  +----------+  +---------------------------------------+  +---------+ |
|  | (Gap)    |  | Region C: Stage Area (Central)        |  | Region D| |
|  |          |  | Position: (250, 140)                  |  | Action  | |
|  +----------+  | Size: (1420, 730)                     |  | Panel   | |
|  | Region B:|  |                                       |  | (1690,  | |
|  | Scoring  |  | 此处承载:                             |  |  140)   | |
|  | Panel    |  | - Select Blind Stage                  |  | Size:   | |
|  | (10, 210)|  | - Proof Stage                         |  |(220,730)| |
|  | Size:    |  | - Shop / Cashout Stage                |  +---------+ |
|  | (230,860)|  |                                       |              |
|  |          |  +---------------------------------------+  [10px Gap]  |
|  |          |  | Region E: Player Hand (Bottom)        |  +---------+ |
|  |          |  | Position: (250, 880)                  |  | (Gap)   | |
|  |          |  | Size: (1420, 190)                     |  |         | |
|  +----------+  +---------------------------------------+  +---------+ |
|  [10px Margin]                                                        |
+-----------------------------------------------------------------------+
```

#### 3.1 全局 + 各区域内部排版（ASCII 一眼看懂版）

> 目标：让读文档的人不需要跑项目，就能“扫一眼”理解每个小区域的内部排版。

**Global Layout（Region Map）**

```text
+----------------------------------------------------------------------------------+
| PhaseInfo (10,10)  | Region A: Joker Row (250,10)                                |
|                    | [J1][J2][J3][J4]...[Jn]                                     |
|----------------------------------------------------------------------------------|
| Region B: Scoring  | Region C: Stage (Main)                    | Region D: Action|
| (10,210)           | (250,140)                                 | (1690,140)      |
|                    |                                           |                 |
|                    |   [Stage Content changes by phase]        | [Buttons]       |
|                    |                                           |                 |
|                    |-------------------------------------------------------------|
|                    |  Region E: Hand (250,880)                                   |
|                    |  (fanned cards)  [C1] [C2] [C3] [C4] [C5] [C6]              |
+----------------------------------------------------------------------------------+
```

**Phase Info（左上）**

```text
┌───────────────┐
│ PHASE         │
│ SELECT BLIND  │
└───────────────┘
```

**Region A：Joker Row（顶部）**

```text
┌──────────────────────────────────────────────────────────────────────┐
│  JOKERS:  [J1] [J2] [J3] [J4] ... [Jn]                                │
└──────────────────────────────────────────────────────────────────────┘
```

**Region B：Scoring Panel（左侧）**

```text
┌──────────────────────────────┐
│  ┌────────────────────────┐  │
│  │ MONEY              $123 │  │
│  └────────────────────────┘  │
│                              │
│      ┌──────────────────┐    │
│      │      SCORE       │    │
│      │       420        │    │
│      │   Target: 900    │    │
│      └──────────────────┘    │
│                              │
│  ┌──────────┐  ×  ┌──────────┐  │
│  │    0     │     │     1    │  │
│  └──────────┘     └──────────┘  │
│                              │
│  ┌────────────────────────┐  │
│  │ HANDS                 3 │  │
│  └────────────────────────┘  │
│  ┌────────────────────────┐  │
│  │ DISCARDS              2 │  │
│  └────────────────────────┘  │
│  ┌────────────────────────┐  │
│  │ ANTE                  1 │  │
│  └────────────────────────┘  │
│                              │
│  ┌────────────────────────┐  │
│  │ [ RUN INFO ]           │  │
│  └────────────────────────┘  │
│  ┌────────────────────────┐  │
│  │ [ OPTIONS  ]           │  │
│  └────────────────────────┘  │
└──────────────────────────────┘
```

**Region C：Stage（中央舞台）**

```text
┌──────────────────────────────────────────────────────────────────────┐
│ [Stage Root]                                                         │
│                                                                      │
│  - Select Blind:  (cards / buttons / preview)                        │
│  - Proof:         (proof task / table / interactions)                │
│  - Shop/Cashout:  (inventory / prices / purchase actions)            │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

**Region D：Action Panel（右侧操作）**

```text
┌──────────────────────┐
│ [Primary Actions]     │
│  - PLAY / OPEN EDITOR │
│  - DISCARD            │
│  - SUBMIT             │
│                       │
│ [Secondary]           │
│  - HELP / SETTINGS    │
└──────────────────────┘
```

**Region E：Hand（底部手牌）**

```text
┌──────────────────────────────────────────────────────────────────────┐
│  (Fanned Hand)  [A]   [&]   [B]   [v]   [C]   [~]                    │
│                (drag to reorder / click to play)                     │
└──────────────────────────────────────────────────────────────────────┘
```

| 区域 | 名称 | 起始坐标 (X, Y) | 建议尺寸 (W, H) | 功能描述 |
| :--- | :--- | :--- | :--- | :--- |
| **左上** | **阶段信息** | (10, 10) | (230, 100) | **唯一**显示当前游戏状态（Phase Name）的区域。 |
| **顶部** | **Joker 栏** | (250, 10) | (1420, 120) | 展示特殊卡牌。 |
| **左侧** | **计分面板** | (10, 210) | (230, 860) | 显示分数、目标、金钱、手牌、**Ante**、**Run Info**、**Options**。 |
| **中央** | **舞台区域** | (250, 140) | (1420, 730) | 核心动态容器。**不再**额外显示阶段名称标题。 |
| **右侧** | **操作面板** | (1690, 140) | (220, 730) | 包含功能按钮。 |
| **底部** | **玩家手牌** | (250, 880) | (1420, 190) | 扇形排列逻辑卡牌。 |
| **覆盖** | **逻辑编辑器** | (250, 140) | (1660, 930) | 覆盖 Region C, D, E。由 Flame 背景容器 + Flutter Overlay 组成。 |
| **全局覆盖** | **信息/选项窗口** | (0, 0) | (1920, 1080) | 覆盖全屏。包含 Run Info (Reward Table) 和 Options (Give Up)。采用随机方向 Fly-in/out。 |

### 4. 计分面板内部布局细节 (Scoring Panel Internal)

为了确保视觉清晰度并防止长数值导致的文字重叠，计分面板内部遵循以下规则：

- **数值右对齐**: 金钱、手牌数、弃牌数等动态数值统一采用 `Anchor.centerRight` 靠右对齐。
- **标签固定位置**: "MONEY"、"HANDS"、"DISCARDS"、"ANTE" 等标签固定在区域左侧，与数值之间保留足够的安全间距。
- **垂直间距优化**: 
  - 分数显示区（SCORE Box）居于面板中上部，与顶部的金钱区及底部的状态区保持明确的视觉区隔。
  - **分数拆解区（Breakdown Boxes）**: 在 **SCORE Box 正下方**新增 2 个小显示框（并排），用于展示 Balatro 风格的记分拆解：
    - **CHIPS**：本次计算的 Chips（加和后的基础分）
    - **MULT**：本次计算的 Multiplier（最终乘区，显示为 `xN`）
    - **可视化与系统对接**：已与 `ProofScoring` 系统实时对接，根据当前结论卡牌和推导规则动态显示。
  - **状态区 (Stats Section)**: HANDS, DISCARDS, ANTE 依次垂直排列。
  - **按钮区 (Action Section)**: **RUN INFO** 和 **OPTIONS** 按钮固定在计分面板的**最底部**。
  - 数值与对应的背景装饰（Pill/Box）垂直居中对齐。

### 5. 计分动画与视觉反馈 (Scoring Animations & Feedback)

为了增强游戏感和数值变化的可见性，积分面板采用了分步式的动画流程：

- **数值滚动（Ticking）**: 所有数值（Score, Chips, Mult）在变化时并非瞬间跳变，而是通过线性插值（Lerp）实现快速滚动效果，增强“涨分”的快感。
- **跳动反馈（Jumping）**: 当目标数值发生变化时，对应的文字组件会触发一个缩放动画（Scale Up/Down），作为数值变化的视觉信号。
- **分步结算流程（Sequenced Settlement）**:
  1. **计算阶段**: 提交证明后，系统计算出本次的 Chips 和 Mult。
  2. **展示阶段**: 弹出验证结果窗口（Validation Popup），此时计分面板显示的 Chips 和 Mult 会滚动到计算出的数值。为了让用户看清计算结果，此时 **总分（Score）暂停更新**。
  3. **转移阶段**: 验证窗口关闭后，Chips 和 Mult 动画化归零（Mult 归 1），同时总分（Score）开始向上滚动，模拟数值从拆解框“流入”总分框的过程。
  4. **重置触发**: 只要在当前 Blind 内，Score 保持累积；一旦击败当前 Blind 进入结算（Cashout），Score 在下一场开始前清零。

**Scoring Panel ASCII（示意）**

> 已在上方的「3.1 全局 + 各区域内部排版（ASCII 一眼看懂版）」中提供同样的示意图。

## 过渡动画与坐标所有权 (Transitions & Ownership)

### 1. 坐标所有权标准化
- **Root Layout** 拥有对 **区域容器 (Layer 1)** 的位置决定权。所有的飞入/飞出路径点必须由 Root Layout 基于全局 1080p 坐标定义。
- **区域容器** 拥有对 **内部 GameObject (Layer 2+)** 的布局权。GameObject 的坐标应相对于其父容器（局部坐标），而不是全局坐标。

### 2. 过渡规则 (Transition Rules)
- **禁止叠加动画 (No Double-Animation)**: 严禁同时移动父容器和子 GameObject。
  - *正例*: 阶段切换时，`StageComponent` 容器整体向下飞走，内部元素位置保持相对静止。
  - *反例*: `StageComponent` 向下飞的同时，其内部的标题又在向上飞。这会导致全局坐标计算混乱，造成定位漂移。
- **随机偏移原则 (Randomized Offset Principle)**: 飞入/飞出的位置不再固定，而是通过 `UIConfig.getRandomOffscreenPosition()` 在每一帧/切换时动态生成。
  - *实现细节*: 基于极坐标系生成（随机角度 + 2000-2500px 半径），确保位置分布在屏幕外的一个大环形区域内。
- **阶段切换动画 (Stage Transition)**: 
  - 当 `GamePhase` 发生变化时，旧阶段容器向一个随机方向飞出。
  - 新阶段容器从另一个随机方向飞入，并最终停留在 `UIConfig.stagePos`。
- **可见性强制执行**: 所有的飞出动画在 `completed` 后，必须明确设置 `isVisible = false`，以彻底停止渲染并禁用所有交互逻辑。

### 3. 组件复用与缓存
- `StageComponent` 维护一个 `Map<GamePhase, BoolatroComponent>` 的实例缓存。
- 阶段切换通过将旧 Stage 容器移出屏幕，并将新 Stage 容器移入屏幕实现。

### 4. 卡牌动画 (Card Animations)
- **飞入/飞出 (Fly-in/Fly-out)**:
  - 仅在 **抽牌 (Refill)** 或 **弃牌 (Discard)** 时触发从屏幕外的随机飞入/飞出。
- **平滑过渡 (Smooth Transitions)**:
  - 在手牌与出牌区之间移动时，卡牌直接从当前物理位置飞向目标槽位，不再触发屏幕外随机动画。
  - 实现逻辑：通过 lookup 对应的 GameObject 并利用 `absolutePosition` 实现跨容器位移。

## 视觉规范 (Visual Specs)

### 1. 配色方案 (Color Palette)
- **背景**: `Colors.blueGrey.shade900` 到 `Colors.black` 的线性渐变。
- **状态颜色**:
  - **MONEY**: 橙色 (`Colors.orange.shade700`)。
  - **ANTE**: 靛蓝色 (`Colors.indigo.shade700`)。
  - **SCORE**: 深红色 (`Colors.red.shade900`)。
  - **HANDS**: 蓝色 (`Colors.blue.shade700`)。
  - **DISCARDS**: 浅红 (`Colors.red.shade700`)。

### 2. 特效与交互
- **间距优化**: 6 张手牌模式下，间距锁定为 **140 px**。
- **扇形排列 (Fanned Hand)**: 手牌基于 `Flyable` 混入实现平滑重排，角度计算基于中心索引。
- **GameObject 文字**: 使用 `BoolatroTextComponent` 统一管理文字的过渡动画。
- **混合渲染**: 
  - **Flame Components** 用于核心游戏流程和动态 UI。
  - **Flutter Overlays** 仅用于 `ProofEditor` 等需要原生键盘支持的文本输入场景。需通过 `LayoutBuilder` 配合全局缩放因子，确保 Flutter 坐标系与 Flame 1080p 坐标系完美对齐。

### 3. 编辑器飞入动画同步原则 (Editor Animation Sync)
- **同步驱动**: 逻辑编辑器的飞入动画必须由全局状态（`ProofState.initialEditorPos`）驱动。
- **一致性路径**: 
  - 当触发编辑器时，由触发源（如 `ActionPanel`）生成一个随机起始点并存入状态。
  - **Flame 层**: `EditorContainerComponent` 读取该点作为 `flyTo` 的起点。
  - **Flutter 层**: `ProofEditor` Overlay 使用 `TweenAnimationBuilder` 从该点同步执行飞入。
- **比例锁定**: Overlay 内部应使用 `FittedBox` 配合 1660x930 的虚拟画布，确保内容（字体、按钮）不因物理分辨率变化而产生排版溢出。
