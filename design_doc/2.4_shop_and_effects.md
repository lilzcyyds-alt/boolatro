# 2.4 Shop + Special Cards (Effects) (Phase 4)

## Goal

Implement a **Shop** and a **SpecialCard effect system** that is:
- pure Dart (unit-testable)
- extensible (add new triggers/cards without touching core game loop)
- easy to integrate into phase enter/exit and scoring/cashout

This doc covers the baseline skeleton + demo cards.

## High-level Flow

- Proof phase settlement produces a `scoreDelta` (valid/baseScore or fallbackScore)
- Owned `SpecialCard`s can react via `EffectTrigger.onProofSubmitted`
- The round/blind lifecycle can fire `EffectTrigger.onRoundStart` / `onRoundEnd`
- Clearing a blind transitions: **Proof → Cashout → Shop → SelectBlind**

(Shop UI can be iterated; the data model is the stable contract.)

## Modules

### 1) EffectTrigger

File: `lib/boolatro/effects/effect_trigger.dart`

```dart
enum EffectTrigger {
  onRoundStart,
  onProofSubmitted,
  onRoundEnd,
  onShopEnter,
  onShopExit,
}
```

Notes:
- Add new triggers freely as gameplay expands (e.g. `onCardCycled`, `onBlindSelected`).

### 2) EffectContext

File: `lib/boolatro/effects/effect_context.dart`

Carries runtime info to card logic:
- trigger
- proof validity + score delta
- blind score/target/hands

### 3) EffectPatch

File: `lib/boolatro/effects/effect_patch.dart`

Current baseline fields:
- `addScore`
- `addHands`

Rationale:
- Start minimal.
- Later expand into multipliers, replacements, rerolls, discounts, etc.

### 4) SpecialCard

File: `lib/boolatro/effects/special_card.dart`

```dart
abstract class SpecialCard {
  final String id;
  final String name;
  final int cost;
  EffectPatch onTrigger(EffectContext ctx);
}
```

Design notes:
- Keep `SpecialCard` pure Dart.
- Card logic returns an `EffectPatch` instead of mutating game state directly.

### 5) EffectEngine

File: `lib/boolatro/effects/effect_engine.dart`

- Iterates owned cards
- Merges patches

## Shop Data Model

File: `lib/state/shop_state.dart`

State:
- `money`
- `inventoryLimit`
- `owned`: purchased special cards
- `inventory`: shop offer list

Operations:
- `seedDemoInventory()` (temporary for early iteration)
- `canBuy(card)`
- `buy(card)`

## Demo Cards (Examples)

Folder: `lib/boolatro/effects/cards/`

- `PartnerCard`: on valid proof submit → `+10 score`
- `AlchemyCard`: on invalid proof submit → `+3 score`
- `ExtraHandCard`: on round start → `+1 hand`

These are scaffolding examples for migrating Unity Partner/Alchemy cards.

## Integration Points (Current)

File: `lib/state/run_state.dart`

- At round/blind start:
  - fire `EffectTrigger.onRoundStart`
  - apply `patch.addHands` to `ProofState.handsRemaining`

- At proof submit:
  - compute base/fallback score delta
  - fire `EffectTrigger.onProofSubmitted`
  - apply `patch.addScore` to delta before adding to `blindScore`

- Cashout → Shop:
  - `cashOutAndGoToShop()` converts `blindScore` into money (temporary formula)

## TODO (Next Iterations)

- Real shop generation (rarity pools, rerolls, prices)
- Inventory UI polish (cards, tooltips, disable states)
- More effect patch fields:
  - score multiplier
  - discounts
  - rerolls
  - rule unlocks
  - hand size / token changes
- Phase hooks:
  - call `onShopEnter/onShopExit` from phase transitions
- Proper cashout and fail state.
